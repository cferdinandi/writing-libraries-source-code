<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<title>Clock</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<!-- Styles -->
		<style type="text/css">
			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
				font-size: 112.5%;
				max-width: 40em;
				width: 88%;
				margin-left: auto;
				margin-right: auto;
			}

			label {
				display: block;
				font-weight: bold;
				/*margin-bottom: 1em;*/
			}

			input {
				margin-bottom: 1em;
			}
		</style>
	</head>

	<body>

		<div id="app"></div>


		<!-- Scripts -->
		<script>

			// Add state to object
			var addState = function (obj) {
				// Update state with state change event
				Object.defineProperty(obj, 'changeState', {
					value: function (props) {
						if (this === null) {
							throw new TypeError('Not an object');
						}
						for (var key in props) {
							if (props.hasOwnProperty(key)) {
								obj[key] = props[key];
							}
						}

						// State change event
						var event = new CustomEvent('stateChange', {
							bubbles: true,
							detail: {
								state: obj
							}
						});
						document.dispatchEvent(event);

						return obj;
					}
				});
				return obj;
			};

			var render = function (template, node) {
				if (!node) return;
				node.innerHTML = (typeof template === 'function' ? template() : template);

				// Render event
				var event = new CustomEvent('elementRendered', {
					bubbles: true
				});
				node.dispatchEvent(event);
			};

			var data = {
				greetings: {
					morning: 'Goodmorning!',
					evening: 'Good evening!'
				},
				time: new Date().toLocaleTimeString('en-US')
			};
			var savedData = localStorage.getItem('clockSettings');
			data = addState(savedData ? JSON.parse(savedData) : data);

			var layout =
				'<div id="clock"></div>' +
				'<div id="settings"></div>';

			var getTime = function () {
				var greeting = /am/i.test(data.time) ? data.greetings.morning : data.greetings.evening;
				return '<h1>' + greeting + ' The time is ' + data.time + '</h1>';
			};

			var settings = function () {
				var template =
					'<h2>Settings</h2>' +
					'<form id="settings-form">' +
						'<div>' +
							'<label for="morning-greeting">Morning Greeting</label>' +
							'<input type="text" name="morning-greeting" id="morning-greeting" value="' + data.greetings.morning + '">' +
						'</div>' +

						'<div>' +
							'<label for="evening-greeting">Evening Greeting</label>' +
							'<input type="text" name="evening-greeting" id="evening-greeting" value="' + data.greetings.evening + '"">' +
						'</div>' +
						'<button type="submit">Save Settings</button>' +
					'</form>';
				return template;
			};

			var renderClock = function () {
				render(layout, document.querySelector('#app'));
				render(getTime(), document.querySelector('#clock'));
				render(settings(), document.querySelector('#settings'));
			};

			var tick = function () {
				data.changeState({time: new Date().toLocaleTimeString('en-US')});
			};

			document.addEventListener('stateChange', function () {
				renderClock();
			}, false);

			tick();
			// setInterval(tick, 1000);

			window.addEventListener('submit', function (event) {
				if (!event.target.matches('#settings-form')) return;
				data.changeState({
					greetings: {
						morning: document.querySelector('#morning-greeting').value,
						evening: document.querySelector('#evening-greeting').value,
					}
				});
				localStorage.setItem('clockSettings', JSON.stringify(data));
			}, false);
		</script>
	</body>
</html>